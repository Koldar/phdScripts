#########################################
# PUBLIC MACROS: FEEL FREE TO CHANGE THEM
#########################################

# represent sthe folder, relative to the projhect root directory, where to put the pdf and all the metadata generated by latex
BUILD_FOLDER:=build
# represents the software represenitng the latex compiler to use
LATEX_CC:=pdflatex
# represents the software that we will call to build the bibliography
BIBTEX_CC:=bibtex
# the Latex root source code document that will be use as starting point of the latex build process
# The filename is relative to the project root directory
# No ".tex" extension is needed since it will be automatically appended (e.g., `main.tex` should be written as `main`)
MAIN_SRC:=main
# name of the output that will be generated inside BUILD_FOLDER. No extension is needed (e.g., `main.pdf` should be written as `main`)
OUTPUT_NAME:=main
# Additional latex flags that will be used in the build process. Note that -halt-on-error and -output-directory are automatically added
# to the build process
LATEX_FLAGS:=
# Additional latex flags that will be used in the build process when building the bibliography
BIBTEX_FLAGS:=
COLORIZE_MAPPING:= \
	--map 'r"(.+\W+(Warning\W+.+)"' 'YELLOW + r"\1" + RESET' \
	--map 'r"(.+\W+Overfull\W+.+)"' 'YELLOW + r"\1" + RESET' \
	--map 'r"(.+\W+Underfull\W+.+)"' 'YELLOW + r"\1" + RESET' \
	--map 'r"Error"' 'BOLD_RED + "Error" + RESET' \
	--map 'r"(.+\W+Undefined control sequence.+)"' 'BOLD_RED + r"\1" + RESET' \
	--map 'r"^(.+\W+error\W+.+)"' 'BOLD_RED + r"\1" + RESET' \


#########################################
# PROTECTED MACROS
#########################################

# a semantic version string representing the versioning of the build process
# Follows a quick changelog:
# 1.0 first version
TEMPLATE_VERSION:=1.0
# Some additional regarding the alteration of the build process. Use this to convey to other people your build process customizations
NOTES:=no notes

#########################################
# INTERNAL DETAILS
#########################################

DEFAULT:="\e[0m"
GREEN:="\e[32m"
YELLOW:="\e[33m"
RED:="\e[31m"
BLUE:="\e[34m"
CYAN:="\e[36m"
BOLD_RED:="\e[1;31m"
BOLD_BLUE:="\e[1;34m"
BOLD_GREEN:="\e[1;32m"

.DEFAULT_GOAL:=all

.phony: show-info all clean

show-info:
	@echo $(BOLD_BLUE)"Latex Template version is "$(TEMPLATE_VERSION)$(DEFAULT)
	@echo "Notes from the developer regarding some notoriuos change in this file: "
	@echo $(NOTES)

all: show-info
	@echo $(BOLD_BLUE)"Compiling first time..."$(DEFAULT)
	$(LATEX_CC) -halt-on-error -output-directory=$(BUILD_FOLDER) $(LATEX_FLAGS) $(MAIN_SRC).tex 2>&1 | ./colorize.py $(COLORIZE_MAPPING)
	@if test $? != 0; then echo $(BOLD_RED)"FAILURE!"$(DEFAULT); exit 1; fi

	@echo $(BOLD_BLUE)"Building bibliography..."$(DEFAULT)
	$(BIBTEX_CC) $(BIBTEX_FLAGS) $(BUILD_FOLDER)/$(MAIN_SRC).aux | ./colorize.py $(COLORIZE_MAPPING)
	@if test $? != 0; then echo $(BOLD_RED)"FAILURE!"$(DEFAULT); exit 1; fi
	
	@echo $(BOLD_BLUE)"Compiling second time..."$(DEFAULT)
	$(LATEX_CC) -halt-on-error -output-directory=$(BUILD_FOLDER) $(LATEX_FLAGS) $(MAIN_SRC).tex | ./colorize.py $(COLORIZE_MAPPING)
	@if test $? != 0; then echo $(BOLD_RED)"FAILURE!"$(DEFAULT); exit 1; fi
	@if test "$(BUILD_FOLDER)/$(MAIN_SRC).pdf" != "$(BUILD_FOLDER)/$(OUTPUT_NAME).pdf"; then	mv -v $(BUILD_FOLDER)/$(MAIN_SRC).pdf $(BUILD_FOLDER)/$(OUTPUT_NAME).pdf; fi

	@echo $(BOLD_GREEN)"DONE"$(DEFAULT)
	
clean:
	rm -fv $(BUILD_FOLDER)/*
	@echo $(BOLD_GREEN)"DONE"$(DEFAULT)
